<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Bot</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --primary-color: #2481cc;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --border-radius: 12px;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            line-height: 1.6;
            padding: 16px;
        }

        #app {
            max-width: 1200px;
            margin: 0 auto;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--tg-theme-hint-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--tg-theme-hint-color);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header p {
            color: var(--tg-theme-hint-color);
            font-size: 14px;
        }

        /* Role Switcher */
        .role-switcher {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .role-btn {
            padding: 8px 16px;
            border: 2px solid var(--primary-color);
            border-radius: 20px;
            background: transparent;
            color: var(--primary-color);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .role-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .role-btn:hover {
            opacity: 0.8;
        }

        /* Admin Actions */
        .admin-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .admin-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px;
            border: none;
            border-radius: var(--border-radius);
            background: linear-gradient(135deg, var(--primary-color), #1a6ba8);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(36, 129, 204, 0.3);
        }

        .admin-btn.success {
            background: linear-gradient(135deg, var(--success-color), #388e3c);
        }

        .admin-btn.warning {
            background: linear-gradient(135deg, var(--warning-color), #f57c00);
        }

        .admin-btn .icon {
            font-size: 24px;
        }

        /* Sections */
        .section {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 16px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-badge {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        /* Lists */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .list-item-info {
            flex: 1;
        }

        .list-item-title {
            font-weight: 500;
        }

        .list-item-subtitle {
            font-size: 12px;
            color: var(--tg-theme-hint-color);
        }

        .list-item-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: #e0e0e0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn.danger {
            background: #ffebee;
            color: var(--danger-color);
        }

        .icon-btn:hover {
            opacity: 0.8;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: var(--border-radius);
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-checkbox-group {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
        }

        .form-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            cursor: pointer;
        }

        .form-checkbox-item:hover {
            background: #f5f5f5;
            border-radius: 4px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn:hover {
            opacity: 0.9;
        }

        /* Invite Code Display */
        .invite-code-display {
            background: #e8f5e9;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            margin-top: 16px;
        }

        .invite-code {
            font-size: 24px;
            font-weight: bold;
            font-family: monospace;
            letter-spacing: 2px;
            color: var(--success-color);
        }

        .copy-btn {
            margin-top: 12px;
            padding: 8px 16px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .select {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: var(--border-radius);
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-size: 14px;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-bottom: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .grades-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--tg-theme-bg-color);
        }

        .grades-table thead {
            background: linear-gradient(135deg, var(--primary-color), #1a6ba8);
            color: white;
        }

        .grades-table th {
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
        }

        .grades-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .grades-table tbody tr:hover {
            background-color: rgba(36, 129, 204, 0.05);
        }

        .grade-badge {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: white;
        }

        .grade-10,
        .grade-9 {
            background: linear-gradient(135deg, #4caf50, #45a049);
        }

        .grade-8,
        .grade-7 {
            background: linear-gradient(135deg, #2196f3, #1976d2);
        }

        .grade-6,
        .grade-5 {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        .grade-4,
        .grade-3,
        .grade-2,
        .grade-1 {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        .statistics {
            background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 24px;
        }

        .statistics h2 {
            font-size: 20px;
            margin-bottom: 16px;
            color: var(--primary-color);
        }

        .error {
            padding: 20px;
            background-color: #ffebee;
            color: var(--danger-color);
            border-radius: var(--border-radius);
            text-align: center;
        }

        #debug-log {
            background: #1a1a2e;
            color: #0f0;
            font-family: monospace;
            font-size: 11px;
            padding: 10px;
            margin: 10px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        #debug-log .error {
            color: #f55;
        }

        #debug-log .info {
            color: #0ff;
        }

        .empty-state {
            text-align: center;
            padding: 24px;
            color: var(--tg-theme-hint-color);
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .controls {
                flex-direction: column;
            }

            .select {
                min-width: 100%;
            }

            .admin-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            <div id="debug-log"></div>
        </div>

        <div id="content" style="display:none;">
            <header class="header">
                <h1>School Bot</h1>
                <p id="user-info"></p>
            </header>

            <!-- Role Switcher (–¥–ª—è –º—É–ª—å—Ç–∏—Ä–æ–ª–µ–π) -->
            <div id="role-switcher" class="role-switcher" style="display:none;"></div>

            <!-- ========== ADMIN INTERFACE ========== -->
            <div id="admin-interface" class="interface" style="display:none;">
                <!-- Action Buttons -->
                <div class="admin-actions">
                    <button class="admin-btn" onclick="showModal('addClass')">
                        <span class="icon">üè´</span>
                        <span>–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å</span>
                    </button>
                    <button class="admin-btn" onclick="showModal('addStudent')">
                        <span class="icon">üë®‚Äçüéì</span>
                        <span>–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</span>
                    </button>
                    <button class="admin-btn" onclick="showModal('addSubject')">
                        <span class="icon">üìö</span>
                        <span>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</span>
                    </button>
                    <button class="admin-btn success" onclick="showModal('createInvite')">
                        <span class="icon">üé´</span>
                        <span>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</span>
                    </button>
                    <button class="admin-btn warning" onclick="showModal('assignTeacher')">
                        <span class="icon">üìã</span>
                        <span>–ù–∞–∑–Ω–∞—á–∏—Ç—å —É—á–∏—Ç–µ–ª—è</span>
                    </button>
                    <button class="admin-btn" onclick="showModal('manageAdmins')">
                        <span class="icon">üëë</span>
                        <span>–ê–¥–º–∏–Ω—ã</span>
                    </button>
                </div>

                <!-- Classes Section -->
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">üè´ –ö–ª–∞—Å—Å—ã <span id="classes-count" class="section-badge">0</span></h3>
                    </div>
                    <div id="classes-list"></div>
                </div>

                <!-- Teachers Section -->
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">üë®‚Äçüè´ –£—á–∏—Ç–µ–ª—è <span id="teachers-count" class="section-badge">0</span>
                        </h3>
                    </div>
                    <div id="teachers-list"></div>
                </div>

                <!-- Subjects Section -->
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">üìö –ü—Ä–µ–¥–º–µ—Ç—ã <span id="subjects-count" class="section-badge">0</span>
                        </h3>
                    </div>
                    <div id="subjects-list"></div>
                </div>

                <!-- Invites Section -->
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">üé´ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è <span id="invites-count"
                                class="section-badge">0</span></h3>
                    </div>
                    <div id="invites-list"></div>
                </div>
            </div>

            <!-- ========== TEACHER INTERFACE ========== -->
            <div id="teacher-interface" class="interface" style="display:none;">
                <div class="controls">
                    <select id="student-select" class="select">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞</option>
                    </select>
                </div>
                <div class="table-container">
                    <table class="grades-table">
                        <thead>
                            <tr>
                                <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                                <th>–û—Ü–µ–Ω–∫–∏</th>
                                <th>–°—Ä–µ–¥–Ω–∏–π</th>
                            </tr>
                        </thead>
                        <tbody id="grades-tbody"></tbody>
                    </table>
                </div>
                <div class="statistics">
                    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    <div id="teacher-stats"></div>
                </div>
            </div>

            <!-- ========== PARENT INTERFACE ========== -->
            <div id="parent-interface" class="interface" style="display:none;">
                <div class="controls">
                    <select id="child-select" class="select">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–±–µ–Ω–∫–∞</option>
                    </select>
                </div>
                <div class="statistics">
                    <h2>–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å</h2>
                    <div id="parent-stats"></div>
                </div>
                <div class="table-container">
                    <table class="grades-table">
                        <thead>
                            <tr>
                                <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                                <th>–û—Ü–µ–Ω–∫–∏</th>
                                <th>–°—Ä–µ–¥–Ω–∏–π</th>
                            </tr>
                        </thead>
                        <tbody id="parent-grades-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ========== STUDENT INTERFACE ========== -->
            <div id="student-interface" class="interface" style="display:none;">
                <div class="statistics">
                    <h2>–ú–æ—è —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å</h2>
                    <div id="student-stats"></div>
                </div>
                <div class="table-container">
                    <table class="grades-table">
                        <thead>
                            <tr>
                                <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                                <th>–û—Ü–µ–Ω–∫–∏</th>
                                <th>–°—Ä–µ–¥–Ω–∏–π</th>
                            </tr>
                        </thead>
                        <tbody id="student-grades-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODALS ========== -->

    <!-- Add Class Modal -->
    <div id="modal-addClass" class="modal-overlay">
        <div class="modal">
            <h3 class="modal-title">üè´ –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å</h3>
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞</label>
                <input type="text" id="class-name" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 9–ê">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="hideModal('addClass')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="addClass()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="modal-addStudent" class="modal-overlay">
        <div class="modal">
            <h3 class="modal-title">üë®‚Äçüéì –î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</h3>
            <div class="form-group">
                <label class="form-label">–§–ò–û —É—á–µ–Ω–∏–∫–∞</label>
                <input type="text" id="student-name" class="form-input" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á">
            </div>
            <div class="form-group">
                <label class="form-label">–ö–ª–∞—Å—Å</label>
                <select id="student-class" class="form-select"></select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="hideModal('addStudent')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="addStudent()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Add Subject Modal -->
    <div id="modal-addSubject" class="modal-overlay">
        <div class="modal">
            <h3 class="modal-title">üìö –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</h3>
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞</label>
                <input type="text" id="subject-name" class="form-input" placeholder="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞">
            </div>
            <div class="form-group">
                <label class="form-label">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞</label>
                <select id="subject-max-grade" class="form-select">
                    <option value="5">5 (–ø—è—Ç–∏–±–∞–ª–ª—å–Ω–∞—è)</option>
                    <option value="10" selected>10 (–¥–µ—Å—è—Ç–∏–±–∞–ª–ª—å–Ω–∞—è)</option>
                    <option value="12">12 (–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç–∏–±–∞–ª–ª—å–Ω–∞—è)</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="hideModal('addSubject')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="addSubject()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Create Invite Modal -->
    <div id="modal-createInvite" class="modal-overlay">
        <div class="modal">
            <h3 class="modal-title">üé´ –°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</h3>
            <div id="invite-form">
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</label>
                    <select id="invite-role" class="form-select" onchange="updateInviteForm()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                        <option value="teacher">üë®‚Äçüè´ –£—á–∏—Ç–µ–ª—å</option>
                        <option value="parent">üë®‚Äçüëß –†–æ–¥–∏—Ç–µ–ª—å</option>
                        <option value="student">üìñ –£—á–µ–Ω–∏–∫</option>
                        <option value="admin">üëë –ê–¥–º–∏–Ω</option>
                    </select>
                </div>
                <div id="invite-name-group" class="form-group" style="display:none;">
                    <label class="form-label">–§–ò–û</label>
                    <input type="text" id="invite-name" class="form-input" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á">
                </div>
                <div id="invite-students-group" class="form-group" style="display:none;">
                    <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–æ–≤ (–¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª—è)</label>
                    <div id="invite-students-list" class="form-checkbox-group"></div>
                </div>
                <div id="invite-student-group" class="form-group" style="display:none;">
                    <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞</label>
                    <select id="invite-student" class="form-select"></select>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="hideModal('createInvite')">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-primary" onclick="createInvite()">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>
            <div id="invite-result" style="display:none;">
                <div class="invite-code-display">
                    <p>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!</p>
                    <div class="invite-code" id="generated-code"></div>
                    <button class="copy-btn" onclick="copyInviteCode()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-primary" onclick="resetInviteForm()">–°–æ–∑–¥–∞—Ç—å –µ—â—ë</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Teacher Modal -->
    <div id="modal-assignTeacher" class="modal-overlay">
        <div class="modal">
            <h3 class="modal-title">üìã –ù–∞–∑–Ω–∞—á–∏—Ç—å —É—á–∏—Ç–µ–ª—è</h3>
            <div class="form-group">
                <label class="form-label">–£—á–∏—Ç–µ–ª—å</label>
                <select id="assign-teacher" class="form-select"></select>
            </div>
            <div class="form-group">
                <label class="form-label">–ö–ª–∞—Å—Å</label>
                <select id="assign-class" class="form-select"></select>
            </div>
            <div class="form-group">
                <label class="form-label">–ü—Ä–µ–¥–º–µ—Ç</label>
                <select id="assign-subject" class="form-select"></select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="hideModal('assignTeacher')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="assignTeacher()">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Manage Admins Modal -->
    <div id="modal-manageAdmins" class="modal-overlay">
        <div class="modal">
            <h3 class="modal-title">üëë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º–∏</h3>
            <div id="admins-list-modal"></div>
            <hr style="margin: 16px 0;">
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–Ω–∞—á–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∞</label>
                <select id="new-admin-user" class="form-select"></select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="hideModal('manageAdmins')">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="btn btn-primary" onclick="makeAdmin()">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // ========== GLOBALS ==========
        const debugLog = document.getElementById('debug-log');
        let userId = null;
        let userName = 'User';
        let currentRole = null;
        let userRoles = [];
        let isAdmin = false;

        // ========== LOGGING ==========
        function log(msg, type) {
            const line = document.createElement('div');
            line.className = type || '';
            line.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg;
            debugLog.appendChild(line);
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(msg);
        }

        // ========== API ==========
        const API = {
            baseUrl: window.location.origin,

            async request(method, endpoint, data) {
                const opts = { method, headers: { 'Content-Type': 'application/json' } };
                if (data) opts.body = JSON.stringify(data);
                const res = await fetch(this.baseUrl + endpoint, opts);
                const json = await res.json();
                if (!json.success) throw new Error(json.error || 'API error');
                return json.data;
            },

            // User
            async getUserData(id) {
                try { return await this.request('GET', '/api/user/' + id); }
                catch (e) { log('API error: ' + e.message, 'error'); return null; }
            },

            // Students
            async getStudents() { return await this.request('GET', '/api/students'); },
            async getStudent(id) { return await this.request('GET', '/api/students/' + id); },
            async addStudent(data) { return await this.request('POST', '/api/students', data); },
            async deleteStudent(id) { return await this.request('DELETE', '/api/students/' + id); },

            // Subjects
            async getSubjects() { return await this.request('GET', '/api/subjects'); },
            async addSubject(data) { return await this.request('POST', '/api/subjects', data); },

            // Grades
            async getGrades(sid) { return await this.request('GET', '/api/grades?student_id=' + sid); },
            async getStatistics(sid) { return await this.request('GET', '/api/statistics?student_id=' + sid); },

            // Parent
            async getParentStudents(pid) { return await this.request('GET', '/api/parent/' + pid + '/students'); },

            // Admin - Classes
            async getClasses() { return await this.request('GET', '/api/admin/classes'); },
            async addClass(name) { return await this.request('POST', '/api/admin/classes', { name }); },
            async deleteClass(id) { return await this.request('DELETE', '/api/admin/classes/' + id); },

            // Admin - Teachers
            async getTeachers() { return await this.request('GET', '/api/admin/teachers'); },

            // Admin - Assignments
            async getAssignments() { return await this.request('GET', '/api/admin/assignments'); },
            async addAssignment(data) { return await this.request('POST', '/api/admin/assignments', data); },
            async deleteAssignment(id) { return await this.request('DELETE', '/api/admin/assignments/' + id); },

            // Admin - Invites
            async getInvites() { return await this.request('GET', '/api/admin/invites'); },
            async createInvite(data) { return await this.request('POST', '/api/admin/invites', data); },

            // Admin - Admins
            async getAdmins() { return await this.request('GET', '/api/admin/admins'); },
            async getUsers() { return await this.request('GET', '/api/admin/users'); },
            async makeAdmin(uid) { return await this.request('POST', '/api/admin/admins', { user_id: uid }); },
            async removeAdmin(uid) { return await this.request('DELETE', '/api/admin/admins/' + uid); }
        };

        // ========== TELEGRAM INIT ==========
        function parseUserFromHash() {
            const hash = window.location.hash;
            if (!hash) return null;
            try {
                const params = new URLSearchParams(hash.substring(1));
                const tgData = params.get('tgWebAppData');
                if (tgData) {
                    const dataParams = new URLSearchParams(tgData);
                    const userStr = dataParams.get('user');
                    if (userStr) return JSON.parse(decodeURIComponent(userStr));
                }
            } catch (e) { log('Hash parse error: ' + e.message, 'error'); }
            return null;
        }

        log('=== School Bot Mini App ===', 'info');

        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            tg.expand();
            tg.ready();
            log('Telegram WebApp OK', 'info');
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                userId = tg.initDataUnsafe.user.id;
                userName = tg.initDataUnsafe.user.first_name || 'User';
                log('User from TG: ' + userId, 'info');
            } else if (tg.initData) {
                try {
                    const params = new URLSearchParams(tg.initData);
                    const userStr = params.get('user');
                    if (userStr) {
                        const u = JSON.parse(decodeURIComponent(userStr));
                        userId = u.id;
                        userName = u.first_name || 'User';
                    }
                } catch (e) { }
            }
        }

        if (!userId) {
            const hashUser = parseUserFromHash();
            if (hashUser) {
                userId = hashUser.id;
                userName = hashUser.first_name || 'User';
                log('User from hash: ' + userId, 'info');
            } else {
                log('Demo mode', 'info');
                userId = 12345;
            }
        }

        // ========== HELPERS ==========
        function calcAvg(grades) {
            if (!grades || !grades.length) return '-';
            return (grades.reduce((a, g) => a + g.grade, 0) / grades.length).toFixed(1);
        }

        // ========== MODALS ==========
        function showModal(name) {
            document.getElementById('modal-' + name).classList.add('active');
            if (name === 'addStudent') loadClassesForSelect('student-class');
            if (name === 'createInvite') resetInviteForm();
            if (name === 'assignTeacher') loadAssignmentSelects();
            if (name === 'manageAdmins') loadAdminsModal();
        }

        function hideModal(name) {
            document.getElementById('modal-' + name).classList.remove('active');
        }

        // ========== ADMIN ACTIONS ==========
        async function addClass() {
            const name = document.getElementById('class-name').value.trim();
            if (!name) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞'); return; }
            try {
                await API.addClass(name);
                hideModal('addClass');
                document.getElementById('class-name').value = '';
                loadAdminData();
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        async function addStudent() {
            const name = document.getElementById('student-name').value.trim();
            const className = document.getElementById('student-class').value;
            if (!name || !className) { alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); return; }
            try {
                await API.addStudent({ full_name: name, class_name: className });
                hideModal('addStudent');
                document.getElementById('student-name').value = '';
                loadAdminData();
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        async function addSubject() {
            const name = document.getElementById('subject-name').value.trim();
            const maxGrade = document.getElementById('subject-max-grade').value;
            if (!name) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞'); return; }
            try {
                await API.addSubject({ name, max_grade: parseInt(maxGrade), teacher_id: userId });
                hideModal('addSubject');
                document.getElementById('subject-name').value = '';
                loadAdminData();
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        async function loadClassesForSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>';
            try {
                const classes = await API.getClasses();
                classes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.name;
                    opt.textContent = c.name;
                    select.appendChild(opt);
                });
            } catch (e) {
                log('Error loading classes: ' + e.message, 'error');
            }
        }

        // ========== INVITE ==========
        async function updateInviteForm() {
            const role = document.getElementById('invite-role').value;
            document.getElementById('invite-name-group').style.display =
                (role === 'teacher' || role === 'parent' || role === 'admin') ? 'block' : 'none';
            document.getElementById('invite-students-group').style.display =
                (role === 'parent') ? 'block' : 'none';
            document.getElementById('invite-student-group').style.display =
                (role === 'student') ? 'block' : 'none';

            if (role === 'parent' || role === 'student') {
                const students = await API.getStudents();
                if (role === 'parent') {
                    const list = document.getElementById('invite-students-list');
                    list.innerHTML = '';
                    students.forEach(s => {
                        const div = document.createElement('div');
                        div.className = 'form-checkbox-item';
                        div.innerHTML = `<input type="checkbox" value="${s.student_id}" id="inv-s-${s.student_id}">
                            <label for="inv-s-${s.student_id}">${s.full_name} (${s.class_name || '-'})</label>`;
                        list.appendChild(div);
                    });
                } else {
                    const select = document.getElementById('invite-student');
                    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞</option>';
                    students.filter(s => !s.user_id).forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.student_id;
                        opt.textContent = `${s.full_name} (${s.class_name || '-'})`;
                        select.appendChild(opt);
                    });
                }
            }
        }

        async function createInvite() {
            const role = document.getElementById('invite-role').value;
            if (!role) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è'); return; }

            let fullName = '';
            let targetData = null;

            if (role === 'teacher' || role === 'admin') {
                fullName = document.getElementById('invite-name').value.trim();
                if (!fullName) { alert('–í–≤–µ–¥–∏—Ç–µ –§–ò–û'); return; }
            } else if (role === 'parent') {
                fullName = document.getElementById('invite-name').value.trim();
                if (!fullName) { alert('–í–≤–µ–¥–∏—Ç–µ –§–ò–û —Ä–æ–¥–∏—Ç–µ–ª—è'); return; }
                const checkboxes = document.querySelectorAll('#invite-students-list input:checked');
                if (checkboxes.length === 0) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —É—á–µ–Ω–∏–∫–∞'); return; }
                targetData = { student_ids: Array.from(checkboxes).map(cb => parseInt(cb.value)) };
            } else if (role === 'student') {
                const studentId = document.getElementById('invite-student').value;
                if (!studentId) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞'); return; }
                const students = await API.getStudents();
                const student = students.find(s => s.student_id == studentId);
                fullName = student ? student.full_name : '–£—á–µ–Ω–∏–∫';
                targetData = { student_id: parseInt(studentId) };
            }

            try {
                const result = await API.createInvite({
                    role,
                    full_name: fullName,
                    created_by: userId,
                    target_data: targetData
                });
                document.getElementById('generated-code').textContent = result.code;
                document.getElementById('invite-form').style.display = 'none';
                document.getElementById('invite-result').style.display = 'block';
                loadAdminData();
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        function resetInviteForm() {
            document.getElementById('invite-form').style.display = 'block';
            document.getElementById('invite-result').style.display = 'none';
            document.getElementById('invite-role').value = '';
            document.getElementById('invite-name').value = '';
            document.getElementById('invite-name-group').style.display = 'none';
            document.getElementById('invite-students-group').style.display = 'none';
            document.getElementById('invite-student-group').style.display = 'none';
        }

        function copyInviteCode() {
            const code = document.getElementById('generated-code').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ' + code);
            });
        }

        // ========== ASSIGN TEACHER ==========
        async function loadAssignmentSelects() {
            try {
                const [teachers, classes, subjects] = await Promise.all([
                    API.getTeachers(),
                    API.getClasses(),
                    API.getSubjects()
                ]);

                const teacherSelect = document.getElementById('assign-teacher');
                teacherSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∏—Ç–µ–ª—è</option>';
                teachers.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.user_id;
                    opt.textContent = t.full_name;
                    teacherSelect.appendChild(opt);
                });

                const classSelect = document.getElementById('assign-class');
                classSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>';
                classes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.class_id;
                    opt.textContent = c.name;
                    classSelect.appendChild(opt);
                });

                const subjectSelect = document.getElementById('assign-subject');
                subjectSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>';
                subjects.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.subject_id;
                    opt.textContent = s.name;
                    subjectSelect.appendChild(opt);
                });
            } catch (e) {
                log('Error loading selects: ' + e.message, 'error');
            }
        }

        async function assignTeacher() {
            const teacherId = document.getElementById('assign-teacher').value;
            const classId = document.getElementById('assign-class').value;
            const subjectId = document.getElementById('assign-subject').value;
            if (!teacherId || !classId || !subjectId) { alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); return; }
            try {
                await API.addAssignment({
                    teacher_id: parseInt(teacherId),
                    class_id: parseInt(classId),
                    subject_id: parseInt(subjectId)
                });
                hideModal('assignTeacher');
                loadAdminData();
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        // ========== MANAGE ADMINS ==========
        async function loadAdminsModal() {
            try {
                const [admins, users] = await Promise.all([
                    API.getAdmins(),
                    API.getUsers()
                ]);

                const listEl = document.getElementById('admins-list-modal');
                if (admins.length === 0) {
                    listEl.innerHTML = '<p class="empty-state">–ù–µ—Ç –∞–¥–º–∏–Ω–æ–≤</p>';
                } else {
                    listEl.innerHTML = admins.map(a => `
                        <div class="list-item">
                            <div class="list-item-info">
                                <div class="list-item-title">üëë ${a.full_name}</div>
                                <div class="list-item-subtitle">${a.role}</div>
                            </div>
                            ${a.user_id !== userId ? `<button class="icon-btn danger" onclick="removeAdmin(${a.user_id})">‚úï</button>` : ''}
                        </div>
                    `).join('');
                }

                const select = document.getElementById('new-admin-user');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>';
                const adminIds = admins.map(a => a.user_id);
                users.filter(u => !adminIds.includes(u.user_id)).forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.user_id;
                    opt.textContent = `${u.full_name} (${u.role})`;
                    select.appendChild(opt);
                });
            } catch (e) {
                log('Error loading admins: ' + e.message, 'error');
            }
        }

        async function makeAdmin() {
            const uid = document.getElementById('new-admin-user').value;
            if (!uid) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'); return; }
            try {
                await API.makeAdmin(parseInt(uid));
                loadAdminsModal();
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        async function removeAdmin(uid) {
            if (!confirm('–°–Ω—è—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞?')) return;
            try {
                await API.removeAdmin(uid);
                loadAdminsModal();
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        // ========== LOAD ADMIN DATA ==========
        async function loadAdminData() {
            try {
                const [classes, teachers, subjects, invites, assignments] = await Promise.all([
                    API.getClasses(),
                    API.getTeachers(),
                    API.getSubjects(),
                    API.getInvites(),
                    API.getAssignments()
                ]);

                // Classes
                document.getElementById('classes-count').textContent = classes.length;
                const classesEl = document.getElementById('classes-list');
                if (classes.length === 0) {
                    classesEl.innerHTML = '<p class="empty-state">–ù–µ—Ç –∫–ª–∞—Å—Å–æ–≤</p>';
                } else {
                    classesEl.innerHTML = classes.map(c => `
                        <div class="list-item">
                            <div class="list-item-info">
                                <div class="list-item-title">${c.name}</div>
                                <div class="list-item-subtitle">${c.student_count} —É—á–µ–Ω–∏–∫–æ–≤</div>
                            </div>
                            <button class="icon-btn danger" onclick="deleteClass(${c.class_id})">üóë</button>
                        </div>
                    `).join('');
                }

                // Teachers with assignments
                document.getElementById('teachers-count').textContent = teachers.length;
                const teachersEl = document.getElementById('teachers-list');
                if (teachers.length === 0) {
                    teachersEl.innerHTML = '<p class="empty-state">–ù–µ—Ç —É—á–∏—Ç–µ–ª–µ–π</p>';
                } else {
                    teachersEl.innerHTML = teachers.map(t => {
                        const teacherAssignments = assignments.filter(a => a.teacher_id === t.user_id);
                        const assignmentText = teacherAssignments.length > 0
                            ? teacherAssignments.map(a => `${a.subject_name} (${a.class_name})`).join(', ')
                            : '–ù–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π';
                        return `
                            <div class="list-item">
                                <div class="list-item-info">
                                    <div class="list-item-title">${t.full_name}</div>
                                    <div class="list-item-subtitle">${assignmentText}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Subjects
                document.getElementById('subjects-count').textContent = subjects.length;
                const subjectsEl = document.getElementById('subjects-list');
                if (subjects.length === 0) {
                    subjectsEl.innerHTML = '<p class="empty-state">–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</p>';
                } else {
                    subjectsEl.innerHTML = subjects.map(s => `
                        <div class="list-item">
                            <div class="list-item-info">
                                <div class="list-item-title">${s.name}</div>
                                <div class="list-item-subtitle">–ú–∞–∫—Å–∏–º—É–º: ${s.max_grade}</div>
                            </div>
                        </div>
                    `).join('');
                }

                // Invites
                document.getElementById('invites-count').textContent = invites.length;
                const invitesEl = document.getElementById('invites-list');
                if (invites.length === 0) {
                    invitesEl.innerHTML = '<p class="empty-state">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</p>';
                } else {
                    const roleIcons = { teacher: 'üë®‚Äçüè´', parent: 'üë®‚Äçüëß', student: 'üìñ', admin: 'üëë' };
                    invitesEl.innerHTML = invites.map(i => `
                        <div class="list-item">
                            <div class="list-item-info">
                                <div class="list-item-title">${roleIcons[i.role] || 'üé´'} ${i.full_name}</div>
                                <div class="list-item-subtitle">–ö–æ–¥: <b>${i.code}</b> ‚Ä¢ ${i.role}</div>
                            </div>
                        </div>
                    `).join('');
                }

            } catch (e) {
                log('Error loading admin data: ' + e.message, 'error');
            }
        }

        async function deleteClass(classId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª–∞—Å—Å?')) return;
            try {
                await API.deleteClass(classId);
                loadAdminData();
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        // ========== ROLE INTERFACES ==========
        async function initAdmin() {
            document.getElementById('admin-interface').style.display = 'block';
            await loadAdminData();
        }

        async function initTeacher() {
            document.getElementById('teacher-interface').style.display = 'block';
            const students = await API.getStudents();
            const select = document.getElementById('student-select');
            students.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.student_id;
                opt.textContent = s.full_name + ' (' + (s.class_name || '-') + ')';
                select.appendChild(opt);
            });
            select.onchange = async () => { if (select.value) await loadGrades(select.value, 'grades-tbody'); };
            await loadTeacherStats();
        }

        async function loadGrades(studentId, tbodyId) {
            const grades = await API.getGrades(studentId);
            const subjects = await API.getSubjects();
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';
            subjects.forEach(sub => {
                const sg = grades.filter(g => g.subject_id === sub.subject_id);
                const row = document.createElement('tr');
                row.innerHTML = '<td><strong>' + sub.name + '</strong></td><td>' +
                    (sg.map(g => '<span class="grade-badge grade-' + g.grade + '">' + g.grade + '</span>').join(' ') || '-') +
                    '</td><td><strong>' + calcAvg(sg) + '</strong></td>';
                tbody.appendChild(row);
            });
        }

        async function loadTeacherStats() {
            const students = await API.getStudents();
            let total = 0, cnt = 0;
            for (const s of students) {
                const st = await API.getStatistics(s.student_id);
                if (st && st.overall_average > 0) { total += parseFloat(st.overall_average); cnt++; }
            }
            document.getElementById('teacher-stats').innerHTML = '<p>–£—á–µ–Ω–∏–∫–æ–≤: ' + students.length + ', –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: ' + (cnt ? (total / cnt).toFixed(2) : '-') + '</p>';
        }

        async function initParent() {
            document.getElementById('parent-interface').style.display = 'block';
            const children = await API.getParentStudents(userId);
            const select = document.getElementById('child-select');
            if (!children.length) { document.getElementById('parent-stats').innerHTML = '<p>–ù–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–µ—Ç–µ–π</p>'; return; }
            children.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.student_id;
                opt.textContent = c.full_name;
                select.appendChild(opt);
            });
            select.onchange = async () => {
                if (select.value) {
                    await loadGrades(select.value, 'parent-grades-tbody');
                    const st = await API.getStatistics(select.value);
                    document.getElementById('parent-stats').innerHTML = '<p>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: ' + (st.overall_average || '-') + '</p>';
                }
            };
            if (children.length === 1) { select.value = children[0].student_id; select.onchange(); }
        }

        async function initStudent() {
            document.getElementById('student-interface').style.display = 'block';
            const student = await API.getStudent(userId);
            if (!student) { document.getElementById('student-stats').innerHTML = '<p>–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã</p>'; return; }
            await loadGrades(student.student_id, 'student-grades-tbody');
            const st = await API.getStatistics(student.student_id);
            document.getElementById('student-stats').innerHTML = '<p>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: ' + (st.overall_average || '-') + '</p>';
        }

        function hideAllInterfaces() {
            ['admin', 'teacher', 'parent', 'student'].forEach(role => {
                document.getElementById(role + '-interface').style.display = 'none';
            });
        }

        async function switchRole(role) {
            hideAllInterfaces();
            currentRole = role;

            // Update switcher buttons
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.role === role);
            });

            if (role === 'admin') await initAdmin();
            else if (role === 'teacher') await initTeacher();
            else if (role === 'parent') await initParent();
            else if (role === 'student') await initStudent();
        }

        function showError(msg) {
            document.getElementById('loading').innerHTML = '<div class="error"><p>' + msg + '</p><button onclick="location.reload()" class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å</button></div><div id="debug-log">' + debugLog.innerHTML + '</div>';
        }

        // ========== INIT APP ==========
        async function initApp() {
            try {
                log('initApp userId=' + userId);
                const userData = await API.getUserData(userId);
                log('userData: ' + JSON.stringify(userData));
                if (!userData) { showError('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. ID: ' + userId); return; }

                isAdmin = userData.is_admin;
                currentRole = userData.role;

                // Determine available roles
                userRoles = [];
                if (isAdmin) userRoles.push('admin');
                if (userData.role === 'teacher' || isAdmin) userRoles.push('teacher');
                if (userData.role === 'parent') userRoles.push('parent');
                if (userData.role === 'student') userRoles.push('student');

                // If admin, always start with admin interface
                if (isAdmin) currentRole = 'admin';

                document.getElementById('user-info').textContent = (userData.full_name || userName) + ' (' + currentRole + (isAdmin ? ' üëë' : '') + ')';

                // Show role switcher if multiple roles
                if (userRoles.length > 1) {
                    const switcher = document.getElementById('role-switcher');
                    switcher.style.display = 'flex';
                    const roleLabels = { admin: 'üëë –ê–¥–º–∏–Ω', teacher: 'üë®‚Äçüè´ –£—á–∏—Ç–µ–ª—å', parent: 'üë®‚Äçüëß –†–æ–¥–∏—Ç–µ–ª—å', student: 'üìñ –£—á–µ–Ω–∏–∫' };
                    switcher.innerHTML = userRoles.map(r =>
                        `<button class="role-btn ${r === currentRole ? 'active' : ''}" data-role="${r}" onclick="switchRole('${r}')">${roleLabels[r]}</button>`
                    ).join('');
                }

                // Initialize current role interface
                await switchRole(currentRole);

                log('Success!', 'info');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (e) {
                log('Error: ' + e.message, 'error');
                showError(e.message);
            }
        }

        log('Calling initApp...');
        initApp();
    </script>
</body>

</html>