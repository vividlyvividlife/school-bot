<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Bot - Mini App</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        #debug-log {
            background: #1a1a2e;
            color: #0f0;
            font-family: monospace;
            font-size: 11px;
            padding: 10px;
            margin: 10px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        #debug-log .error {
            color: #f55;
        }

        #debug-log .warn {
            color: #ff0;
        }

        #debug-log .info {
            color: #0ff;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            <div id="debug-log"></div>
        </div>

        <div id="content" style="display: none;">
            <!-- Header -->
            <header class="header">
                <h1 id="page-title">School Bot</h1>
                <p id="user-info"></p>
            </header>

            <!-- Teacher Interface -->
            <div id="teacher-interface" class="interface" style="display: none;">
                <div class="controls">
                    <select id="student-select" class="select">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞</option>
                    </select>
                    <button id="add-student-btn" class="btn btn-primary">+ –î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</button>
                    <button id="add-subject-btn" class="btn btn-success">üìö –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
                    <button id="add-homework-btn" class="btn btn-info">üìù –°–æ–∑–¥–∞—Ç—å –î–ó</button>
                </div>

                <div class="table-container">
                    <table id="grades-table" class="grades-table">
                        <thead>
                            <tr>
                                <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                                <th>–û—Ü–µ–Ω–∫–∏</th>
                                <th>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="grades-tbody">
                        </tbody>
                    </table>
                </div>

                <div class="statistics">
                    <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    <div id="teacher-stats"></div>
                </div>
            </div>

            <!-- Parent Interface -->
            <div id="parent-interface" class="interface" style="display: none;">
                <div class="controls">
                    <select id="child-select" class="select">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–±–µ–Ω–∫–∞</option>
                    </select>
                </div>

                <div class="statistics">
                    <h2>üìä –£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å</h2>
                    <div id="parent-stats"></div>
                </div>

                <div class="table-container">
                    <table id="parent-grades-table" class="grades-table">
                        <thead>
                            <tr>
                                <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                                <th>–û—Ü–µ–Ω–∫–∏</th>
                                <th>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th>
                            </tr>
                        </thead>
                        <tbody id="parent-grades-tbody">
                        </tbody>
                    </table>
                </div>

                <div class="homework-section">
                    <h2>üìù –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h2>
                    <div id="parent-homework"></div>
                </div>
            </div>

            <!-- Student Interface -->
            <div id="student-interface" class="interface" style="display: none;">
                <div class="statistics">
                    <h2>üìä –ú–æ—è —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å</h2>
                    <div id="student-stats"></div>
                </div>

                <div class="table-container">
                    <table id="student-grades-table" class="grades-table">
                        <thead>
                            <tr>
                                <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                                <th>–û—Ü–µ–Ω–∫–∏</th>
                                <th>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th>
                            </tr>
                        </thead>
                        <tbody id="student-grades-tbody">
                        </tbody>
                    </table>
                </div>

                <div class="homework-section">
                    <h2>üìù –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h2>
                    <div id="student-homework"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Grade Modal -->
    <div id="edit-grade-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏</h2>
            <form id="edit-grade-form">
                <input type="hidden" id="edit-grade-id">
                <div class="form-group">
                    <label for="edit-grade-value">–û—Ü–µ–Ω–∫–∞ (1-10):</label>
                    <input type="number" id="edit-grade-value" min="1" max="10" required class="form-control">
                </div>
                <div class="form-group">
                    <label for="edit-grade-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                    <input type="text" id="edit-grade-comment" class="form-control"
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-edit-btn">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Subject Modal -->
    <div id="add-subject-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal" data-modal="add-subject-modal">&times;</span>
            <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</h2>
            <form id="add-subject-form">
                <div class="form-group">
                    <label for="subject-name">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:</label>
                    <input type="text" id="subject-name" required class="form-control"
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞">
                </div>
                <div class="form-group">
                    <label for="subject-max-grade">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª:</label>
                    <input type="number" id="subject-max-grade" min="1" max="100" value="10" required
                        class="form-control">
                    <small>5-–±–∞–ª–ª—å–Ω–∞—è, 10-–±–∞–ª–ª—å–Ω–∞—è, 12-–±–∞–ª–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏ —Ç.–¥.</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-close-modal="add-subject-modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="add-student-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal" data-modal="add-student-modal">&times;</span>
            <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</h2>
            <form id="add-student-form">
                <div class="form-group">
                    <label for="student-full-name">–§–ò–û —É—á–µ–Ω–∏–∫–∞:</label>
                    <input type="text" id="student-full-name" required class="form-control"
                        placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á">
                </div>
                <div class="form-group">
                    <label for="student-class">–ö–ª–∞—Å—Å:</label>
                    <input type="text" id="student-class" required class="form-control" placeholder="9–ê">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-close-modal="add-student-modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Homework Modal -->
    <div id="add-homework-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal" data-modal="add-homework-modal">&times;</span>
            <h2>‚ûï –°–æ–∑–¥–∞—Ç—å –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h2>
            <form id="add-homework-form">
                <div class="form-group">
                    <label for="homework-subject">–ü—Ä–µ–¥–º–µ—Ç:</label>
                    <select id="homework-subject" required class="form-control">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="homework-title">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                    <input type="text" id="homework-title" required class="form-control"
                        placeholder="–†–µ—à–∏—Ç—å –∑–∞–¥–∞—á–∏ 1-10">
                </div>
                <div class="form-group">
                    <label for="homework-description">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea id="homework-description" class="form-control" rows="3"
                        placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è"></textarea>
                </div>
                <div class="form-group">
                    <label for="homework-deadline">–°—Ä–æ–∫ —Å–¥–∞—á–∏:</label>
                    <input type="datetime-local" id="homework-deadline" class="form-control">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary"
                        data-close-modal="add-homework-modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/demo-data.js"></script>
    <script src="js/api.js"></script>
    <script src="js/teacher.js"></script>
    <script src="js/parent.js"></script>
    <script src="js/student.js"></script>
    <script>
        // Debug logger - shows logs on page
        const debugLog = document.getElementById('debug-log');
        function log(msg, type = '') {
            const time = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${time}] ${msg}`;
            debugLog.appendChild(line);
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(msg);
        }

        // Initialize Telegram WebApp
        let tg = null;
        let userId = null;
        let userName = 'User';

        log('=== School Bot Mini App ===', 'info');
        log('URL: ' + window.location.href);

        // Check Telegram WebApp availability
        if (window.Telegram && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
            tg.expand();
            tg.ready();

            log('‚úì Telegram WebApp detected', 'info');
            log('Platform: ' + tg.platform);
            log('Version: ' + tg.version);
            log('InitData length: ' + (tg.initData ? tg.initData.length : 0));
            log('InitData: ' + (tg.initData || '(empty)'));

            // Get user data from Telegram
            const initData = tg.initDataUnsafe;
            log('InitDataUnsafe: ' + JSON.stringify(initData));

            if (initData && initData.user) {
                userId = initData.user.id;
                userName = initData.user.first_name || 'User';
                log('‚úì User from initDataUnsafe: ' + userId, 'info');
            } else {
                log('‚ö† No user in initDataUnsafe', 'warn');

                // Try to parse user from raw initData string
                if (tg.initData) {
                    try {
                        const params = new URLSearchParams(tg.initData);
                        const userStr = params.get('user');
                        log('User param: ' + (userStr || '(none)'));
                        if (userStr) {
                            const userObj = JSON.parse(decodeURIComponent(userStr));
                            userId = userObj.id;
                            userName = userObj.first_name || 'User';
                            log('‚úì User parsed: ' + userId, 'info');
                        }
                    } catch (e) {
                        log('‚úó Parse error: ' + e.message, 'error');
                    }
                } else {
                    log('‚úó InitData is empty!', 'error');
                }
            }
        } else {
            log('‚Ñπ Demo mode (no Telegram)', 'warn');
            userId = 12345;
            userName = '–î–µ–º–æ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        }

        // Get role from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const roleParam = urlParams.get('role');
        log('Role param: ' + (roleParam || '(none)'));

        // Initialize app
        async function initApp() {
            try {
                log('Starting initApp, userId=' + userId);

                if (!userId) {
                    log('‚úó No userId!', 'error');
                    showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID. Platform: ${tg?.platform}, InitData: ${tg?.initData ? '–µ—Å—Ç—å' : '–ø—É—Å—Ç–æ'}`);
                    return;
                }

                log('Fetching API data...');
                const userData = await API.getUserData(userId);
                log('API response: ' + JSON.stringify(userData));

                if (!userData) {
                    log('‚úó User not in DB', 'error');
                    showError(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. ID: ${userId}`);
                    return;
                }

                let role = roleParam || userData.role;
                if (userData.is_admin) {
                    role = 'admin';
                }
                log('Role: ' + role, 'info');

                const displayName = userData.full_name || userName;
                document.getElementById('user-info').textContent = `${displayName} (${getRoleName(role)})`;

                log('Loading interface...');
                if (role === 'teacher' || role === 'admin') {
                    await initTeacherInterface(userId);
                } else if (role === 'parent') {
                    await initParentInterface(userId);
                } else if (role === 'student') {
                    await initStudentInterface(userId);
                } else {
                    log('‚úó Unknown role: ' + role, 'error');
                    showError(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å: ${role}`);
                    return;
                }

                log('‚úì Success!', 'info');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                log('‚úó Error: ' + error.message, 'error');
                showError('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function getRoleName(role) {
            const roles = {
                'teacher': '–£—á–∏—Ç–µ–ª—å',
                'parent': '–†–æ–¥–∏—Ç–µ–ª—å',
                'student': '–£—á–µ–Ω–∏–∫',
                'admin': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'
            };
            return roles[role] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        }

        function showError(message) {
            log('Show error: ' + message, 'error');
            const loading = document.getElementById('loading');
            // Keep debug log visible
            loading.innerHTML = `
                <div class="error">
                    <p>‚ùå ${message}</p>
                    <button onclick="location.reload()" class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div id="debug-log" style="background:#1a1a2e;color:#0f0;font-family:monospace;font-size:11px;padding:10px;margin:10px;border-radius:8px;max-height:300px;overflow-y:auto;white-space:pre-wrap;">${debugLog.innerHTML}</div>
            `;
        }

        // Start app
        log('Calling initApp()...');
        initApp();
    </script>
</body>

</html>