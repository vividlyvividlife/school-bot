<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Bot - Mini App</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body>
    <div id="app">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>

        <div id="content" style="display: none;">
            <!-- Header -->
            <header class="header">
                <h1 id="page-title">School Bot</h1>
                <p id="user-info"></p>
            </header>

            <!-- Teacher Interface -->
            <div id="teacher-interface" class="interface" style="display: none;">
                <div class="controls">
                    <select id="student-select" class="select">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞</option>
                    </select>
                    <button id="add-student-btn" class="btn btn-primary">+ –î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</button>
                </div>

                <div class="table-container">
                    <table id="grades-table" class="grades-table">
                        <thead>
                            <tr>
                                <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                                <th>–û—Ü–µ–Ω–∫–∏</th>
                                <th>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="grades-tbody">
                            <!-- Grades will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <div class="statistics">
                    <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    <div id="teacher-stats"></div>
                </div>
            </div>

            <!-- Parent Interface -->
            <div id="parent-interface" class="interface" style="display: none;">
                <div class="controls">
                    <select id="child-select" class="select">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–±–µ–Ω–∫–∞</option>
                    </select>
                </div>

                <div class="statistics">
                    <h2>üìä –£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å</h2>
                    <div id="parent-stats"></div>
                </div>

                <div class="table-container">
                    <table id="parent-grades-table" class="grades-table">
                        <thead>
                            <tr>
                                <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                                <th>–û—Ü–µ–Ω–∫–∏</th>
                                <th>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th>
                            </tr>
                        </thead>
                        <tbody id="parent-grades-tbody">
                            <!-- Grades will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <div class="homework-section">
                    <h2>üìù –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h2>
                    <div id="parent-homework"></div>
                </div>
            </div>

            <!-- Student Interface -->
            <div id="student-interface" class="interface" style="display: none;">
                <div class="statistics">
                    <h2>üìä –ú–æ—è —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å</h2>
                    <div id="student-stats"></div>
                </div>

                <div class="table-container">
                    <table id="student-grades-table" class="grades-table">
                        <thead>
                            <tr>
                                <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                                <th>–û—Ü–µ–Ω–∫–∏</th>
                                <th>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th>
                            </tr>
                        </thead>
                        <tbody id="student-grades-tbody">
                            <!-- Grades will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <div class="homework-section">
                    <h2>üìù –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h2>
                    <div id="student-homework"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/demo-data.js"></script>
    <script src="js/api.js"></script>
    <script src="js/teacher.js"></script>
    <script src="js/parent.js"></script>
    <script src="js/student.js"></script>
    <script>
        // Initialize Telegram WebApp
        let tg = null;
        let userId = null;
        let userName = 'User';

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) {
            tg = window.Telegram.WebApp;
            tg.expand();
            tg.ready();

            // Get user data from Telegram
            const initData = tg.initDataUnsafe;
            userId = initData.user?.id;
            userName = initData.user?.first_name || 'User';
        } else {
            // –î–µ–º–æ-—Ä–µ–∂–∏–º: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            console.log('üîß –†–∞–±–æ—Ç–∞–µ–º –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ (–≤–Ω–µ Telegram)');
            userId = 12345; // –î–µ–º–æ user_id
            userName = '–î–µ–º–æ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        }

        // Get role from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const roleParam = urlParams.get('role');

        // Initialize app
        async function initApp() {
            try {
                // Get user data
                const userData = API.getUserData(userId);

                if (!userData) {
                    showError('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }

                // Use role from URL parameter or from user data
                const role = roleParam || userData.role;
                document.getElementById('user-info').textContent = `${userName} (${getRoleName(role)})`;

                // Show appropriate interface
                if (role === 'teacher') {
                    await initTeacherInterface(userId);
                } else if (role === 'parent') {
                    await initParentInterface(userId);
                } else if (role === 'student') {
                    await initStudentInterface(userId);
                }

                // Hide loading, show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                console.error('Init error:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        function getRoleName(role) {
            const roles = {
                'teacher': '–£—á–∏—Ç–µ–ª—å',
                'parent': '–†–æ–¥–∏—Ç–µ–ª—å',
                'student': '–£—á–µ–Ω–∏–∫'
            };
            return roles[role] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        }

        function showError(message) {
            document.getElementById('loading').innerHTML = `
                <div class="error">
                    <p>‚ùå ${message}</p>
                    <button onclick="location.reload()" class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            `;
        }

        // Start app
        initApp();
    </script>
</body>

</html>